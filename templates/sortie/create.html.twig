{% extends 'base.html.twig' %}

{% block title %}Créer une sortie{% endblock %}

{% block body %}

    {% include 'components/_header.html.twig' %}

    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h1 class="h3 mb-0">Créer une sortie</h1>
                    </div>

                    <div class="card-body p-4">
                        {{ form_start(sortieForm, {'attr': {'novalidate': 'novalidate'}}) }}

                        <div class="mb-4">
                            {{ form_label(sortieForm.nomSortie, null, {'label_attr': {'class': 'form-label fw-bold'}}) }}
                            <span class="text-danger">*</span>
                            {{ form_widget(sortieForm.nomSortie, {'attr': {'class': 'form-control', 'placeholder': 'Ex: Soirée cinéma, Randonnée en forêt...'}}) }}
                            <div class="invalid-feedback d-block">{{ form_errors(sortieForm.nomSortie) }}</div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6 mb-3 mb-md-0">
                                {{ form_label(sortieForm.dateDebut, null, {'label_attr': {'class': 'form-label fw-bold'}}) }}
                                <span class="text-danger">*</span>
                                {{ form_widget(sortieForm.dateDebut, {'attr': {'class': 'form-control'}}) }}
                                <div class="invalid-feedback d-block">{{ form_errors(sortieForm.dateDebut) }}</div>
                            </div>

                            <div class="col-md-6">
                                {{ form_label(sortieForm.duree, null, {'label_attr': {'class': 'form-label fw-bold'}}) }}
                                <span class="text-danger">*</span>
                                {{ form_widget(sortieForm.duree, {'attr': {'class': 'form-control', 'placeholder': 'Durée en minutes'}}) }}
                                <div class="invalid-feedback d-block">{{ form_errors(sortieForm.duree) }}</div>
                                <div class="form-text">Durée prévue de la sortie en minutes</div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6 mb-3 mb-md-0">
                                {{ form_label(sortieForm.dateCloture, null, {'label_attr': {'class': 'form-label fw-bold'}}) }}
                                <span class="text-danger">*</span>
                                {{ form_widget(sortieForm.dateCloture, {'attr': {'class': 'form-control'}}) }}
                                <div class="invalid-feedback d-block">{{ form_errors(sortieForm.dateCloture) }}</div>
                                <div class="form-text">Date limite pour s'inscrire</div>
                            </div>

                            <div class="col-md-6">
                                {{ form_label(sortieForm.nbInscriptionMax, null, {'label_attr': {'class': 'form-label fw-bold'}}) }}
                                <span class="text-danger">*</span>
                                {{ form_widget(sortieForm.nbInscriptionMax, {'attr': {'class': 'form-control', 'placeholder': 'Nombre maximum de participants'}}) }}
                                <div class="invalid-feedback d-block">{{ form_errors(sortieForm.nbInscriptionMax) }}</div>
                            </div>
                        </div>

                        <div class="mb-4">
                            {{ form_label(sortieForm.descriptionInfos, null, {'label_attr': {'class': 'form-label fw-bold'}}) }}
                            {{ form_widget(sortieForm.descriptionInfos, {'attr': {'class': 'form-control', 'placeholder': 'Décrivez votre sortie : lieu de rendez-vous, matériel à apporter, programme prévu...', 'rows': '4'}}) }}
                            <div class="invalid-feedback d-block">{{ form_errors(sortieForm.descriptionInfos) }}</div>
                        </div>

                        {# Champ adresse avec suggestions stylé #}
                        <div class="mb-4">
                            <div class="position-relative">
                                {{ form_label(sortieForm.adresse, null, {'label_attr': {'class': 'form-label fw-bold'}}) }}
                                <span class="text-danger">*</span>
                                {{ form_widget(sortieForm.adresse, {'attr': {'class': 'form-control', 'placeholder': 'Tapez l\'adresse du lieu de la sortie', 'data-address-input': 'true'}}) }}
                                <ul id="adresse-suggestions" class="list-group position-absolute w-100" style="display: none; z-index: 1000; top: 100%;"></ul>
                                <div class="invalid-feedback d-block">{{ form_errors(sortieForm.adresse) }}</div>
                                <div class="form-text">Commencez à taper pour voir les suggestions d'adresses</div>
                            </div>
                        </div>

                        {# Champs cachés #}
                        {{ form_widget(sortieForm.adresse_full, {'attr': {'class': 'd-none'}}) }}
                        {{ form_widget(sortieForm.rue, {'attr': {'class': 'd-none'}}) }}
                        {{ form_widget(sortieForm.latitude, {'attr': {'class': 'd-none'}}) }}
                        {{ form_widget(sortieForm.longitude, {'attr': {'class': 'd-none'}}) }}
                        {{ form_widget(sortieForm.ville_nom, {'attr': {'class': 'd-none'}}) }}
                        {{ form_widget(sortieForm.code_postal, {'attr': {'class': 'd-none'}}) }}

                        <div class="row mb-4">
                            <div class="col-md-6 mb-3 mb-md-0">
                                {{ form_label(sortieForm.statut, null, {'label_attr': {'class': 'form-label fw-bold'}}) }}
                                <span class="text-danger">*</span>
                                {{ form_widget(sortieForm.statut, {'attr': {'class': 'form-select'}}) }}
                                <div class="invalid-feedback d-block">{{ form_errors(sortieForm.statut) }}</div>
                            </div>

                            <div class="col-md-6">
                                {{ form_label(sortieForm.campus, null, {'label_attr': {'class': 'form-label fw-bold'}}) }}
                                <span class="text-danger">*</span>
                                {{ form_widget(sortieForm.campus, {'attr': {'class': 'form-select'}}) }}
                                <div class="invalid-feedback d-block">{{ form_errors(sortieForm.campus) }}</div>
                            </div>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                            <button type="submit" class="btn btn-primary btn-lg me-md-2">
                                <i class="fas fa-plus me-2"></i>Créer la sortie
                            </button>
                            <a href="{{ path('app_sortie_list') }}" class="btn btn-outline-secondary btn-lg">
                                <i class="fas fa-times me-2"></i>Annuler
                            </a>
                        </div>
                        {{ form_end(sortieForm) }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function() {
            const input = document.querySelector('[data-address-input="true"]');
            const list = document.getElementById('adresse-suggestions');

            if (!input || !list) return;

            let controller;

            function clearSuggestions() {
                list.innerHTML = '';
                list.style.display = 'none';
            }

            function selectFeature(f) {
                // API Adresse: lon,lat
                const [lon, lat] = f.geometry.coordinates;
                const props = f.properties;

                // Récupération des champs du formulaire
                const form = input.closest('form');
                form.querySelector('[name$="[adresse_full]"]').value = props.label || '';
                form.querySelector('[name$="[rue]"]').value = props.name || props.street || props.label || '';
                form.querySelector('[name$="[latitude]"]').value = lat || '';
                form.querySelector('[name$="[longitude]"]').value = lon || '';
                form.querySelector('[name$="[ville_nom]"]').value = props.city || props.name || '';
                form.querySelector('[name$="[code_postal]"]').value = props.postcode || '';

                // Affiche le choix dans l'input principal
                input.value = props.label || '';
                clearSuggestions();
            }

            async function fetchSuggestions(q) {
                const url = 'https://api-adresse.data.gouv.fr/search/?q=' + encodeURIComponent(q) + '&limit=5';
                if (controller) controller.abort();
                controller = new AbortController();
                const resp = await fetch(url, { signal: controller.signal });
                if (!resp.ok) return [];
                const data = await resp.json();
                return data.features || [];
            }

            function renderSuggestions(features) {
                clearSuggestions();
                if (!features.length) return;

                features.forEach(f => {
                    const li = document.createElement('li');
                    li.textContent = f.properties.label;
                    li.className = 'list-group-item list-group-item-action';
                    li.addEventListener('mousedown', e => {
                        e.preventDefault();
                        selectFeature(f);
                    });
                    list.appendChild(li);
                });

                list.style.display = 'block';
            }

            let debounce;
            input.addEventListener('input', async () => {
                const q = input.value.trim();
                if (!q) {
                    clearSuggestions();
                    return;
                }
                clearTimeout(debounce);
                debounce = setTimeout(async () => {
                    try {
                        const features = await fetchSuggestions(q);
                        renderSuggestions(features);
                    } catch (_) { /* ignore */ }
                }, 250);
            });

            document.addEventListener('click', (e) => {
                if (!list.contains(e.target) && e.target !== input) {
                    clearSuggestions();
                }
            });
        })();
    </script>

    {% include 'components/_footer.html.twig' %}

{% endblock %}