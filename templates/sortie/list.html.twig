{% extends 'base.html.twig' %}

{% block title %}Liste des Sorties | {{ parent() }}{% endblock %}

{% block body %}

    {% include 'components/_header.html.twig' %}

    <div class="container py-4">
        <h1 class="mb-4 text-center">Liste des sorties</h1>


        {#        ---------------------------------------------------- La barre des différents filtres --------------------------------------------------- -#}

        <form method="get" action="{{ path('app_sortie_list') }}" class="mb-4">
            <div class="row g-3 align-items-end">

                <div class="col-md-4">
                    <label for="search" class="form-label">Nom de l'évènement</label>
                    <input
                            type="text"
                            name="search"
                            id="search"
                            class="form-control"
                            placeholder="Rechercher une sortie..."
                            value="{{ app.request.get('search') }}"
                    >
                </div>

                <div class="col-md-3">
                    <label for="sortDate" class="form-label">Date</label>
                    <select name="sortDate" id="sortDate" class="form-select">
                        <option value="">-- Aucun tri --</option>
                        <option value="asc" {% if app.request.get('sortDate') == 'asc' %}selected{% endif %}>Croissant
                        </option>
                        <option value="desc" {% if app.request.get('sortDate') == 'desc' %}selected{% endif %}>
                            Décroissant
                        </option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label for="participantRange" class="form-label">Nombre de participants</label>
                    <select name="participantRange" id="participantRange" class="form-select">
                        <option value="">-- Toutes les tranches --</option>
                        <option value="0-5" {% if app.request.get('participantRange') == '0-5' %}selected{% endif %}>0 -
                            5
                        </option>
                        <option value="6-10" {% if app.request.get('participantRange') == '6-10' %}selected{% endif %}>6
                            - 10
                        </option>
                        <option value="11-15"
                                {% if app.request.get('participantRange') == '11-15' %}selected{% endif %}>11 - 15
                        </option>
                        <option value="16-20"
                                {% if app.request.get('participantRange') == '16-20' %}selected{% endif %}>16 - 20
                        </option>
                        <option value="21+" {% if app.request.get('participantRange') == '21+' %}selected{% endif %}>
                            + de 20
                        </option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label for="campus" class="form-label">Campus</label>
                    <select name="campus" id="campus" class="form-select">
                        <option value="">-- Tous les campus --</option>
                        {% for c in ['Rennes', 'Niort', 'Nantes', 'Quimper'] %}
                            <option value="{{ c }}"
                                    {% if app.request.get('campus') == c %}selected{% endif %}>{{ c }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-3">
                    <label for="categorie" class="form-label">Catégorie</label>
                    <select name="categorie" id="categorie" class="form-select">
                        <option value="">-- Toutes les catégories --</option>
                        {% for cat in ['Culture', 'Sport', 'Loisirs', 'Détente', 'Formation', 'Autre'] %}
                            <option value="{{ cat }}"
                                    {% if app.request.get('categorie') == cat %}selected{% endif %}>{{ cat }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-3">
                    <div class="form-check">
                        <input
                                class="form-check-input"
                                type="checkbox"
                                name="isInscrit"
                                id="isInscrit"
                                value="1"
                                {% if app.request.get('isInscrit') %}checked{% endif %}
                        >
                        <label class="form-check-label" for="isInscrit">
                            Sorties auxquelles je suis inscrit
                        </label>
                    </div>

                <div class="form-check">
                    <input
                            class="form-check-input"
                            type="checkbox"
                            name="isOrganisateur"
                            id="isOrganisateur"
                            value="1"
                            {% if app.request.get('estOrganisateur') %}checked{% endif %}
                    >
                    <label class="form-check-label" for="isOrganisateur">
                        Mes sorties créées
                    </label>
                </div>
                </div>

                <div class="col-md-12 mt-3">
                    <button type="submit"
                            class="btn btn-primary"
                            style="background-color: #8f00ff; border-color: #8f00ff; transition: all 0.3s ease;"
                            onmouseover="this.style.backgroundColor='#7300cc'; this.style.borderColor='#7300cc';"
                            onmouseout="this.style.backgroundColor='#8f00ff'; this.style.borderColor='#8f00ff';">
                        Filtrer
                    </button>

                    {% if app.user %}
                        <a href="{{ path('app_sortie_create') }}" class="btn btn-primary">Créer une sortie</a>
                    {% endif %}
                </div>
            </div>
        </form>


        {#- ----------------------------------------------- Affichage des sorties ----------------------------------------------- -#}

        <div class="row g-4">
            {% for s in sorties %}
                <div class="col-md-6">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h5 class="card-title mb-0">{{ s.nomSortie }}</h5>
                        </div>
                        <div class="card-body d-flex flex-column">
                            <p class="card-text"><strong>Date de début
                                    :</strong> {{ s.dateDebut ? s.dateDebut|date('d/m/Y H:i') : 'N/A' }}</p>
                            <p class="card-text"><strong>Durée :</strong> {{ s.duree }} heures</p>
                            <p class="card-text"><strong>Date de clôture
                                    :</strong> {{ s.dateCloture ? s.dateCloture|date('d/m/Y') : 'N/A' }}</p>
                            <p class="card-text"><strong>Max participants :</strong> {{ s.nbInscriptionMax }}</p>
                            <p class="card-text"><strong>Adresse :</strong> {{ s.lieu.nomLieu }}</p>
                            <p class="card-text"><strong>Catégorie :</strong> {{ s.categorie }}</p>
                            <p class="card-text"><strong>Organisateur :</strong></p>
                            {% if s.participant %}
                                {% set displayName = (s.participant.prenom is defined and s.participant.prenom ? (s.participant.prenom ~ ' ') : '') ~
                                    (s.participant.nom is defined and s.participant.nom ? s.participant.nom : '') %}
                                <dd class="col-sm-8">
                                    <a href="{{ path('app_utilisateur_profil_public', {'id': s.participant.id}) }}"
                                       class="text-decoration-none fw-medium"
                                       style="color: #8f00ff;"
                                       onmouseover="this.style.color='#7300cc';"
                                       onmouseout="this.style.color='#8f00ff';">
                                        <i class="fas fa-user me-1"></i>
                                        {{ displayName is not empty ? displayName :
                                        (sortie.participant.username is defined and sortie.participant.username ? sortie.participant.username :
                                        (sortie.participant.email is defined and sortie.participant.email ? sortie.participant.email : 'Inconnu')) }}
                                    </a>
                                </dd>
                            {% else %}
                                <dd class="col-sm-8">
                                <span class="text-muted">
                                    <i class="fas fa-user-slash me-1"></i>Inconnu
                                </span>
                                </dd>
                            {% endif %}
                            <div class="mt-auto d-flex gap-2">
                                <a href="{{ path('app_sortie_show', {'id': s.id}) }}"
                                   class="btn btn-outline-primary flex-grow-1">Détails</a>

                                {% if app.user %}
                                    {% set estOrganisateur = s.participant and app.user.id == s.participant.id %}
                                    {% set estInscrit = false %}

                                    {% for inscription in s.inscriptions %}
                                        {% if inscription.participant and inscription.participant.id == app.user.id %}
                                            {% set estInscrit = true %}
                                        {% endif %}
                                    {% endfor %}

                                    {% set nbInscrits = s.inscriptions|length %}
                                    {% set maxInscrits = s.nbInscriptionMax %}

                                    {% if not estOrganisateur %}
                                        {% if estInscrit %}
                                            <form method="post" action="{{ path('app_sortie_desister', {'id': s.id}) }}"
                                                  class="flex-grow-1">
                                                <input type="hidden" name="_token"
                                                       value="{{ csrf_token('desister' ~ s.id) }}">
                                                <button type="submit" class="btn btn-danger w-100">Se désister</button>
                                            </form>
                                        {% elseif nbInscrits < maxInscrits %}
                                            <form method="post"
                                                  action="{{ path('app_sortie_rejoindre', {'id': s.id}) }}"
                                                  class="flex-grow-1">
                                                <input type="hidden" name="_token"
                                                       value="{{ csrf_token('rejoindre' ~ s.id) }}">
                                                <button type="submit" class="btn btn-success w-100">Rejoindre</button>
                                            </form>
                                        {% else %}
                                            {# Ne rien afficher si la sortie est complète #}
                                        {% endif %}
                                    {% endif %}

                                {% else %}
                                    <a href="{{ path('app_utilisateur_inscription') }}"
                                       class="btn btn-primary flex-grow-1">Inscription au site</a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% else %}
                <p class="text-center">Aucune sortie trouvée.</p>
            {% endfor %}
        </div>
    </div>

    {% include 'components/_footer.html.twig' %}

{% endblock %}
